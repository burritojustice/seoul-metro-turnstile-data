import:
  - https://mapzen.com/carto/refill-style-no-labels/4/refill-style-no-labels.yaml

textures:
  pois:
    url: './refill@2x.png'
    filtering: mipmap
    sprites:
      # define sprites: [x origin, y origin, width, height]
      train: [410, 0, 36, 36]

global:
  selected_station: null
  lng: 'en'

styles:
  alpha_polygons:
    base: polygons
    blend: multiply
  icons:
    base: points
    texture: pois
    blend_order: 1

sources:
  isochrone:
    type: GeoJSON
    url: './isochrone.json'
  subway_line:
    type: GeoJSON
    url: '../data/subway-line-shape.geojson'

  stations:
    type: GeoJSON
    url: './lets-see.geojson'
    scripts: ['./processAttribute.js']

layers:
  isochrone:
    data: { source: isochrone}
    draw:
      alpha_polygons:
        order: 2999
        color: |
          function() {
              if (feature.contour == 30) return '#9fbf40';
           }
  subway_line:
    data: { source: subway_line}
    draw:
      lines:
        order: 3000
        color: |
          function() {
            return feature.line_color
          }
        width: 3px
        outline:
          color: gray
          width: 1px
  # previous_data:
  #   data: { source: previous_data}
  #   draw:
  #     points:
  #       order: 3500
  #       size: |
  #         function () {
  #           var size = 0;
  #           for (var i = 0; i < feature.dates.length;i++) {
  #             size += feature.dates[i].turnstile_data[0].exits;
  #           }
  #           return size/7000;
  #         }
  #       color: [1.0, 0.8, 0.0]
  selected-data:
    data: { source: stations}
    draw:
      points:
        centroid: true
        collide: false
        color: gray
        size: |
          function () {
            if (global.selected_station) {
              if (global.selected_station == feature.station_name) {
                var size = 0;
                  var previousSize = 0;
                for (var i = 0; i < feature.dates.length;i++) {
                  size += feature.dates[i].turnstile_data[0].exits;
                  previousSize += feature.previous_data[i].turnstile_data[0].exits;
                }
                return (Math.sqrt((size-previousSize)/50)+ 15);
              } else {
                return 0;
              }
              } else {
                var size = 0;
                var previousSize = 0;
                for (var i = 0; i < feature.dates.length;i++) {
                  size += feature.dates[i].turnstile_data[0].exits;
                  previousSize += feature.previous_data[i].turnstile_data[0].exits;
                }
                return (Math.sqrt((size-previousSize)/50)+ 10);
            }
          }
  stations:
    data: { source: stations}
    draw:
      points:
        interactive: true
        centroid: true
        collide: false
        color: rgb(239, 59, 44)
        size: |
          function () {
            return getSizeByProperty(feature);
          }
        text:
          collide: false
          centroid: true
          anchor: bottom
          text_source: |
            function () {
              if (global.lng == 'en') return feature.station_name_eng
              else return feature.station_name;
            }
          font:
            stroke: {color: gray, width: 5 }
            fill: white
            size: 12px