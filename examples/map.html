<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>서울시 지하철역별 이용객 데이터</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://mapzen.com/js/mapzen.css">
  <link rel="stylesheet" href="./css/map-page.css">
</head>
<body>

  <div id="map-30min"></div>
  <script src="https://mapzen.com/js/mapzen.min.js"></script>
  <script src="./assets/globalAsset.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.4.0/d3.js"></script>
  <script src="./js/subgraph.js"></script>
  <script>

    L.Mapzen.apiKey = 'matrix-5kvnWuh';
    var map = L.Mapzen.map('map-30min',{
      tangramOptions: {
        scene: 'assets/detailed-scene.yaml'
      },
      zoomControl: false
    });

    map.setView([37.5601,126.9794], 14.3);

    // add legend
    var legend = L.control({position: 'bottomleft'});
    var selectedDiv;
    var selectedLabel;
    var maxRad, minRad;

    var formatNumber = d3.format(",");

    var request = new XMLHttpRequest();
    request.open('GET', './assets/total.json', true);

    request.onload = function() {
      if (this.status >= 200 && this.status < 400) {
        // Success!
        var data = JSON.parse(this.response);

        legend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'info');
        div.setAttribute('id','legend');

        var graphDiv = L.DomUtil.create('div', '');
        graphDiv.setAttribute('id','graph-box');

        var circleDiv = L.DomUtil.create('div', 'circle-wrapper');

        selectedDiv = L.DomUtil.create('div', 'circle selected');
        var maximumDiv = L.DomUtil.create('div', 'circle maximum');
        var minimumDiv = L.DomUtil.create('div', 'circle minimum');

        selectedDiv.style.backgroundColor = 'gray';
        maxRad = globalAsset.getSizeByProperty(data.max.properties);//globalAsset.getSizeByProperty(78486);
        minRad = globalAsset.getSizeByProperty(data.min.properties);//globalAsset.getSizeByProperty(891);

        maximumDiv.style.width = maxRad +'px';
        maximumDiv.style.height = maxRad+'px';
        minimumDiv.style.width = minRad+'px';
        minimumDiv.style.height = minRad+'px';
        minimumDiv.style.left = (maxRad - minRad)/2 + 'px'

        circleDiv.appendChild(maximumDiv);
        circleDiv.appendChild(selectedDiv);
        circleDiv.appendChild(minimumDiv);

        var labelDiv = L.DomUtil.create('div', 'label-wrapper');

        var maxLabel = L.DomUtil.create('div', 'max label');
        var minLabel = L.DomUtil.create('div', 'min label');
        selectedLabel = L.DomUtil.create('div', 'selected label');

        maxLabel.style.left = maxRad/2+ 'px';
        maxLabel.style.bottom = maxRad+ 'px';
        minLabel.style.left = maxRad/2+ 'px';
        minLabel.style.bottom = minRad-21+ 'px';
        selectedLabel.style.width = '0';

        maxLabel.innerHTML = globalAsset.words['max'][globalAsset.lng] + ' : ' + formatNumber(globalAsset.getAvereageIncrement(data.max.properties));
        minLabel.innerHTML =  globalAsset.words['min'][globalAsset.lng] + ' : ' + formatNumber(globalAsset.getAvereageIncrement(data.min.properties));
        //selectedLabel.style.left = maxRad/2+ 'px';
        //selectedLabel.style.top = maxRad/2+ 'px';


        labelDiv.appendChild(maxLabel);
        labelDiv.appendChild(minLabel);
        labelDiv.appendChild(selectedLabel);

        circleDiv.appendChild(labelDiv);

        div.appendChild(circleDiv);
        div.appendChild(graphDiv);


        return div;
      };

      legend.addTo(map);

      Graph.prepareData(data.total.properties);
      Graph.createGraph();
      } else {
        // We reached our target server, but it returned an error

      }
    };

    request.onerror = function() {
      // There was a connection error of some sort
    };

    request.send();

    L.Mapzen.hash({
      map: map
    })


    map.on('tangramloaded', function(e) {

      var popup = document.createElement('div');
      popup.setAttribute('id', 'popup');
      map.getContainer().append(popup);

      var graphDiv = document.createElement('div');
      graphDiv.setAttribute('id','graph-box');
      map.getContainer().append(graphDiv);


      var scene = e.tangramLayer.scene;

      // feature edit popup
      map.getContainer().addEventListener('touchstart', function(event) {
        var pixel = { x:event.touches[0].clientX, y: event.touches[0].clientY };
        scene.getFeatureAt(pixel).then(function(selection) {
          if(selection.feature) {
            if (selection.feature.source_name == 'stations') {
              scene.config.global.selected_station = selection.feature.properties.station_name;
              scene.rebuild().then(function () {
                // graphDiv.innerHTML = '';
                Graph.prepareData(selection.feature.properties);
                Graph.updateGraph();
              })
            }
          }
        });
      })

      map.getContainer().addEventListener('mousedown', function (event) {
        var pixel = { x: event.clientX, y: event.clientY };
        scene.getFeatureAt(pixel).then(function(selection) {
          if(selection.feature) {
            if (selection.feature.source_name == 'stations') {
              scene.config.global.selected_station = selection.feature.properties.station_name;

              selectedDiv.style.width = globalAsset.getSizeByProperty(selection.feature.properties) +'px';
              selectedDiv.style.height = globalAsset.getSizeByProperty(selection.feature.properties) +'px';
              selectedDiv.style.left = (maxRad -  globalAsset.getSizeByProperty(selection.feature.properties))/2+'px';
              selectedLabel.style.width = '70%';
              selectedLabel.style.left = (maxRad/2)+'px';
              selectedLabel.innerHTML =  globalAsset.words['gap'][globalAsset.lng] + ' : ' + formatNumber(globalAsset.getAvereageIncrement(selection.feature.properties));
              selectedLabel.style.bottom = (globalAsset.getSizeByProperty(selection.feature.properties)-21)+ 'px';
              scene.rebuild().then(function () {
                // graphDiv.innerHTML = '';
                Graph.prepareData(selection.feature.properties);
                Graph.updateGraph();
              })
            }
          }

        });
      });
    });

  </script>
</body>
</html>
